{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"https://github.com/virtualjj/cis-aws-foundations-cloudformation",
   "Parameters":{
      "Email":{
         "Type":"String",
         "Description":"Email address to notify when an API activity has triggered an alarm"
      },
      "SetYourALARMTopicName":{
         "Type":"String",
         "Description":"(Optional) Set a descriptive name for your SNS Topic.",
         "MinLength":"1",
         "MaxLength":"256",
         "AllowedPattern":"[\\w_-]*"
      },
      "SetYourALARMTopicDisplayName":{
         "Type":"String",
         "Description":"(Optional but Required for SMS). Set a descriptive name for your SNS Topic Display Name up to 10 characters.",
         "MinLength":"0",
         "MaxLength":"10",
         "AllowedPattern":"[\\w_-]*"
      },
      "SetYourTRAILTopicName":{
         "Type":"String",
         "Description":"(Optional) Set a descriptive name for your CloudTrail SNS Topic.",
         "MinLength":"1",
         "MaxLength":"256",
         "AllowedPattern":"[\\w_-]*"
      },
      "SetYourTRAILTopicDisplayName":{
         "Type":"String",
         "Description":"(Optional but Required for SMS). Set a descriptive name for your CloudTrail SNS Topic Display Name up to 10 characters.",
         "MinLength":"0",
         "MaxLength":"10",
         "AllowedPattern":"[\\w_-]*"
      },
      "CloudWatchLogsRetentionInDays":{
         "Description":"The number of days log events are kept in CloudWatch Logs",
         "Type":"Number",
         "AllowedValues":[
            1,
            3,
            5,
            7,
            14,
            30,
            60,
            90,
            120,
            150,
            180,
            365,
            400,
            545,
            731,
            1827,
            3653
         ],
         "Default":14
      },
      "S3BucketCloudTrail":{
         "Description":"Enter an unique name for your CloudTrail S3 bucket.",
         "Type":"String",
         "AllowedPattern":"[a-z0-9.-]+",
         "ConstraintDescription":"The bucket name must contain only lowercase letters, numbers, periods (.), and dashes (-)."
      },
      "CloudTrailLogGroupName":{
         "Description":"Enter a name for your CloudTrail LogGroup.",
         "Type":"String",
         "Default":"CloudTrail/DefaultLogGroup",
         "MinLength":"1",
         "MaxLength":"512",
         "AllowedPattern":"[\\w-/.]+",
         "ConstraintDescription":"Log group names can be between 1 and 512 characters long. Allowed characters include a-z, A-Z, 0-9, '_' (underscore), '-' (hyphen), '/' (forward slash), and '.' (period)."
      },
      "NameYourCloudTrailRole":{
         "Description":"A unique name for your CloudTrail Role",
         "Type":"String",
         "MinLength":"1",
         "MaxLength":"64",
         "AllowedPattern":"[a-zA-Z0-9+=,.@-]+",
         "ConstraintDescription":"The role name must contain only upper and lowercase alphanumeric characters with no spaces. These characters are alllowed: = , . @ -"
      }
   },
   "Resources":{
      "TrailBucket":{
         "DeletionPolicy":"Delete",
         "Type":"AWS::S3::Bucket",
         "Properties":{
            "BucketName":{
               "Ref":"S3BucketCloudTrail"
            }
         }
      },
      "TrailBucketPolicy":{
         "Type":"AWS::S3::BucketPolicy",
         "Properties":{
            "Bucket":{
               "Ref":"TrailBucket"
            },
            "PolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Sid":"AWSCloudTrailAclCheck",
                     "Effect":"Allow",
                     "Principal":{
                        "Service":"cloudtrail.amazonaws.com"
                     },
                     "Action":"s3:GetBucketAcl",
                     "Resource":{
                        "Fn::Join":[
                           "",
                           [
                              "arn:aws:s3:::",
                              {
                                 "Ref":"TrailBucket"
                              }
                           ]
                        ]
                     }
                  },
                  {
                     "Sid":"AWSCloudTrailWrite",
                     "Effect":"Allow",
                     "Principal":{
                        "Service":"cloudtrail.amazonaws.com"
                     },
                     "Action":"s3:PutObject",
                     "Resource":{
                        "Fn::Join":[
                           "",
                           [
                              "arn:aws:s3:::",
                              {
                                 "Ref":"TrailBucket"
                              },
                              "/AWSLogs/",
                              {
                                 "Ref":"AWS::AccountId"
                              },
                              "/*"
                           ]
                        ]
                     },
                     "Condition":{
                        "StringEquals":{
                           "s3:x-amz-acl":"bucket-owner-full-control"
                        }
                     }
                  }
               ]
            }
         }
      },
      "TrailLogGroup":{
         "Type":"AWS::Logs::LogGroup",
         "Properties":{
            "LogGroupName":{
               "Ref":"CloudTrailLogGroupName"
            },
            "RetentionInDays":{
               "Ref":"CloudWatchLogsRetentionInDays"
            }
         }
      },
      "TrailLogGroupRole":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "RoleName":{
               "Ref":"NameYourCloudTrailRole"
            },
            "AssumeRolePolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Sid":"AssumeRole1",
                     "Effect":"Allow",
                     "Principal":{
                        "Service":"cloudtrail.amazonaws.com"
                     },
                     "Action":"sts:AssumeRole"
                  }
               ]
            },
            "Policies":[
               {
                  "PolicyName":"cloudtrail-policy",
                  "PolicyDocument":{
                     "Version":"2012-10-17",
                     "Statement":[
                        {
                           "Sid":"AWSCloudTrailCreateLogStream2014110",
                           "Effect":"Allow",
                           "Action":[
                              "logs:CreateLogStream"
                           ],
                           "Resource":[
                              {
                                 "Fn::GetAtt":[
                                    "TrailLogGroup",
                                    "Arn"
                                 ]
                              }
                           ]
                        },
                        {
                           "Sid":"AWSCloudTrailPutLogEvents20141101",
                           "Effect":"Allow",
                           "Action":[
                              "logs:PutLogEvents"
                           ],
                           "Resource":[
                              {
                                 "Fn::GetAtt":[
                                    "TrailLogGroup",
                                    "Arn"
                                 ]
                              }
                           ]
                        }
                     ]
                  }
               }
            ]
         }
      },
      "TrailTopic":{
         "Type":"AWS::SNS::Topic",
         "Properties":{
            "DisplayName":{
               "Ref":"SetYourTRAILTopicDisplayName"
            },
            "TopicName":{
               "Ref":"SetYourTRAILTopicName"
            }
         }
      },
      "TrailTopicPolicy":{
         "Type":"AWS::SNS::TopicPolicy",
         "Properties":{
            "PolicyDocument":{
               "Version":"2008-10-17",
               "Statement":[
                  {
                     "Sid":"AWSCloudTrailSNSPolicy",
                     "Effect":"Allow",
                     "Principal":{
                        "Service":"cloudtrail.amazonaws.com"
                     },
                     "Resource":{
                        "Ref":"TrailTopic"
                     },
                     "Action":"sns:Publish"
                  }
               ]
            },
            "Topics":[
               {
                  "Ref":"TrailTopic"
               }
            ]
         }
      },
      "Trail":{
         "DependsOn":[
            "TrailBucketPolicy",
            "TrailTopicPolicy"
         ],
         "Type":"AWS::CloudTrail::Trail",
         "Properties":{
            "IncludeGlobalServiceEvents":true,
            "IsLogging":true,
            "IsMultiRegionTrail":true,
            "S3BucketName":{
               "Ref":"TrailBucket"
            },
            "CloudWatchLogsLogGroupArn":{
               "Fn::GetAtt":[
                  "TrailLogGroup",
                  "Arn"
               ]
            },
            "CloudWatchLogsRoleArn":{
               "Fn::GetAtt":[
                  "TrailLogGroupRole",
                  "Arn"
               ]
            },
            "SnsTopicName":{
               "Fn::GetAtt":[
                  "TrailTopic",
                  "TopicName"
               ]
            }
         }
      },
      "AlarmNotificationTopic":{
         "Type":"AWS::SNS::Topic",
         "Properties":{
            "DisplayName":{
               "Ref":"SetYourALARMTopicDisplayName"
            },
            "TopicName":{
               "Ref":"SetYourALARMTopicName"
            },
            "Subscription":[
               {
                  "Endpoint":{
                     "Ref":"Email"
                  },
                  "Protocol":"email"
               }
            ]
         }
      },
      "312NGatewayChangesMetricFilter":{
         "DependsOn":[
            "TrailLogGroup"
         ],
         "Type":"AWS::Logs::MetricFilter",
         "Properties":{
            "LogGroupName":{
               "Ref":"CloudTrailLogGroupName"
            },
            "FilterPattern":"{ ($.eventName = CreateCustomerGateway) || ($.eventName = DeleteCustomerGateway) || ($.eventName = AttachInternetGateway) || ($.eventName = CreateInternetGateway) || ($.eventName = DeleteInternetGateway) || ($.eventName = DetachInternetGateway) }",
            "MetricTransformations":[
               {
                  "MetricName":"CIS-BENCHMARK-NETGATEWAY-CHANGES",
                  "MetricNamespace":"CIS-SECURITY",
                  "MetricValue":"1"
               }
            ]
         }
      },
      "312RouteTableChangesChangesAlarm":{
         "Type":"AWS::CloudWatch::Alarm",
         "Properties":{
            "AlarmName":"CIS-BENCHMARK-NETGATEWAY-CHANGES",
            "AlarmDescription":"Alarms when changes are made to Network Gateways.",
            "AlarmActions":[
               {
                  "Ref":"AlarmNotificationTopic"
               }
            ],
            "MetricName":"CIS-BENCHMARK-NETGATEWAY-CHANGES",
            "Namespace":"CIS-SECURITY",
            "ComparisonOperator":"GreaterThanOrEqualToThreshold",
            "EvaluationPeriods":"1",
            "Period":"300",
            "Statistic":"Sum",
            "Threshold":"1"
         }
      },
      "313RouteTableChangesMetricFilter":{
         "DependsOn":[
            "TrailLogGroup"
         ],
         "Type":"AWS::Logs::MetricFilter",
         "Properties":{
            "LogGroupName":{
               "Ref":"CloudTrailLogGroupName"
            },
            "FilterPattern":"{ ($.eventName = CreateRoute) || ($.eventName = CreateRouteTable) || ($.eventName = ReplaceRoute) || ($.eventName = ReplaceRouteTableAssociation) || ($.eventName = DeleteRouteTable) || ($.eventName = DeleteRoute) || ($.eventName = DisassociateRouteTable) }",
            "MetricTransformations":[
               {
                  "MetricName":"CIS-BENCHMARK-ROUTETABLE-CHANGES",
                  "MetricNamespace":"CIS-SECURITY",
                  "MetricValue":"1"
               }
            ]
         }
      },
      "313RouteTableChangesChangesAlarm":{
         "Type":"AWS::CloudWatch::Alarm",
         "Properties":{
            "AlarmName":"CIS-BENCHMARK-ROUTETABLE-CHANGES",
            "AlarmDescription":"Alarms when changes are made to Route Tables.",
            "AlarmActions":[
               {
                  "Ref":"AlarmNotificationTopic"
               }
            ],
            "MetricName":"CIS-BENCHMARK-ROUTETABLE-CHANGES",
            "Namespace":"CIS-SECURITY",
            "ComparisonOperator":"GreaterThanOrEqualToThreshold",
            "EvaluationPeriods":"1",
            "Period":"300",
            "Statistic":"Sum",
            "Threshold":"1"
         }
      },
      "314VPCChangesMetricFilter":{
         "DependsOn":[
            "TrailLogGroup"
         ],
         "Type":"AWS::Logs::MetricFilter",
         "Properties":{
            "LogGroupName":{
               "Ref":"CloudTrailLogGroupName"
            },
            "FilterPattern":"{ ($.eventName = CreateVpc) || ($.eventName = DeleteVpc) || ($.eventName = ModifyVpcAttribute) || ($.eventName = AcceptVpcPeeringConnection) || ($.eventName = CreateVpcPeeringConnection) || ($.eventName = DeleteVpcPeeringConnection) || ($.eventName = RejectVpcPeeringConnection) || ($.eventName = AttachClassicLinkVpc) || ($.eventName = DetachClassicLinkVpc) || ($.eventName = DisableVpcClassicLink) || ($.eventName = EnableVpcClassicLink) }",
            "MetricTransformations":[
               {
                  "MetricName":"CIS-BENCHMARK-VPC-CHANGES",
                  "MetricNamespace":"CIS-SECURITY",
                  "MetricValue":"1"
               }
            ]
         }
      },
      "314VPCChangesChangesAlarm":{
         "Type":"AWS::CloudWatch::Alarm",
         "Properties":{
            "AlarmName":"CIS-BENCHMARK-VPC-CHANGES",
            "AlarmDescription":"Alarms when changes are made to VPCs.",
            "AlarmActions":[
               {
                  "Ref":"AlarmNotificationTopic"
               }
            ],
            "MetricName":"CIS-BENCHMARK-VPC-CHANGES",
            "Namespace":"CIS-SECURITY",
            "ComparisonOperator":"GreaterThanOrEqualToThreshold",
            "EvaluationPeriods":"1",
            "Period":"300",
            "Statistic":"Sum",
            "Threshold":"1"
         }
      }
   }
}